#!/bin/bash
# Auto-generated by AntiGravity
# Hardened Version: Checks CONNECTION_ID and Interface
INTERFACE=$1
ACTION=$2

# Log everything for debugging
logger "AntiGravity-Dispatcher: Event=$ACTION Interface=$INTERFACE Connection=$CONNECTION_ID"

# Check if this is the MaHarNet 5G Connection (by Name or Interface)
if [ "$CONNECTION_ID" = "MaHarNet5G" ] || [ "$INTERFACE" = "wlp1s0" ]; then
    if [ "$ACTION" = "up" ]; then
        logger "ðŸš€ AntiGravity: applying optimizations to $INTERFACE..."
        
        # 1. Regulatory Domain (Critical)
        iw reg set US
        
        # 2. TxPower (Critical)
        iw dev wlp1s0 set txpower fixed 2000
        
        # 3. MSS Clamping (Critical for Anti-Stall)
        # Clear old rules first to avoid duplicates
        iptables -t mangle -D OUTPUT -p tcp --tcp-flags SYN,RST SYN -o wlp1s0 -j TCPMSS --set-mss 1320 2>/dev/null || true
        iptables -t mangle -D POSTROUTING -p tcp --tcp-flags SYN,RST SYN -o wlp1s0 -j TCPMSS --set-mss 1320 2>/dev/null || true
        
        # Apply new rules
        iptables -t mangle -A OUTPUT -p tcp --tcp-flags SYN,RST SYN -o wlp1s0 -j TCPMSS --set-mss 1320
        iptables -t mangle -A POSTROUTING -p tcp --tcp-flags SYN,RST SYN -o wlp1s0 -j TCPMSS --set-mss 1320
        
        logger "âœ… AntiGravity: Optimization Complete (Reg=US, Tx=20dBm, MSS=1320)"
    fi
fi
